name: Deploy Webhook Configuration

on:
  push:
    branches: [main]
    paths:
      - 'deployment/webhook.json.template'
      - '.github/workflows/deploy-webhook-config.yml'
  workflow_dispatch:

jobs:
  deploy-webhook-config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate webhook.json from template
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # Replace the placeholder in the template with the actual secret
          envsubst < deployment/webhook.json.template > deployment/webhook.json

          # Verify the file was generated correctly (without exposing the secret)
          echo "Generated webhook.json file:"
          jq -r '.[0].match[0].secret = "[REDACTED]"' deployment/webhook.json

      - name: Commit and push webhook.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Only commit if there are changes
          if ! git diff --quiet deployment/webhook.json; then
            git add deployment/webhook.json
            git commit -m "ðŸ”’ Update webhook.json with secret from GitHub Secrets [skip deploy]"
            git push
          else
            echo "No changes to webhook.json"
          fi

      - name: Notify deployment status
        if: success()
        run: |
          echo "âœ… Webhook configuration deployed successfully"
          echo "ðŸ”’ Secret is now sourced from GitHub Secrets"
          echo "ðŸš€ Next deployment will use the updated configuration"